<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rutas Óptimas con Mapa</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
        }

        #map {
            height: 100vh;
        }

        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            width: 280px;
        }

        button {
            width: 100%;
            padding: 10px;
            font-size: 15px;
            font-weight: bold;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button2 {
            width: 100%;
            padding: 10px;
            font-size: 15px;
            font-weight: bold;
            background-color: #31aa8c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;

            .btn-clasica {
                width: 100%;
                padding: 10px;
                font-size: 15px;
                font-weight: bold;
                background-color: #31aa8c;
                /* Tu color verde */
                color: white;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                transition: background-color 0.2s;
                margin-top: 10px;
                /* Añadimos un margen para separarlo */
            }






        }

        button:hover {
            background-color: #c9302c;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #results {
            margin-top: 15px;
            font-size: 14px;
        }
    </style>
</head>

<body>

    <div id="map"></div>

    <div class="info-panel">
        <h3>Planificador de Ruta</h3>
        <p>1. Haz clic en el mapa para fijar el <strong>INICIO</strong>.</p>
        <p>2. Haz clic de nuevo para fijar el <strong>FIN</strong>.</p>

        <button id="calculateBtn" disabled>Calcular Ruta</button>



        <button id="resetBtn" style="margin-top: 10px; background-color: #5bc0de;">Reiniciar</button>

        <div id="results"></div>

        <button id="btnIrACalculadora" class="btn-clasica">Calculadora Clásica</button>
    </div>


    <script>

        document.getElementById('btnIrACalculadora').addEventListener('click', function () {
            window.location.href = '/calculadora';
        });
        // --- 1. Inicialización del Mapa ---
        const map = L.map('map').setView([-12.08, -77.05], 13); // Centrado en Lima

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© OpenStreetMap'
        }).addTo(map);

        // --- 2. Variables para guardar el estado ---
        let startPoint = null;
        let endPoint = null;
        let startMarker = null;
        let endMarker = null;
        let routeLayer = null;

        const calculateBtn = document.getElementById('calculateBtn');
        const resetBtn = document.getElementById('resetBtn');
        const resultsDiv = document.getElementById('results');

        // Ícono rojo para el marcador de fin
        const redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // --- 3. Lógica de Clics en el Mapa ---
        map.on('click', function (e) {
            if (!startPoint) {
                startPoint = e.latlng;
                startMarker = L.marker(startPoint, { draggable: true }).addTo(map).bindPopup('Punto de Inicio').openPopup();
                // Actualizar coordenada si el marcador es arrastrado
                startMarker.on('dragend', function (e) { startPoint = e.target.getLatLng(); });
            } else if (!endPoint) {
                endPoint = e.latlng;
                endMarker = L.marker(endPoint, { icon: redIcon, draggable: true }).addTo(map).bindPopup('Punto de Fin').openPopup();
                endMarker.on('dragend', function (e) { endPoint = e.target.getLatLng(); });
                calculateBtn.disabled = false; // Habilitar el botón de cálculo
            }
        });

        // --- 4. Lógica de los Botones ---
        calculateBtn.addEventListener('click', function () {
            resultsDiv.innerHTML = "Calculando...";
            calculateBtn.disabled = true;

            fetch('/ruta_json', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    start: [startPoint.lat, startPoint.lng],
                    end: [endPoint.lat, endPoint.lng]
                })
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error del servidor: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (routeLayer) {
                        map.removeLayer(routeLayer); // Limpiar ruta anterior
                    }
                    if (data.ruta && data.ruta.length > 0) {
                        routeLayer = L.polyline(data.ruta, { color: '#3388ff', weight: 5 }).addTo(map);
                        map.fitBounds(routeLayer.getBounds().pad(0.1)); // Zoom a la ruta
                        resultsDiv.innerHTML = `<p><strong>Tiempo estimado:</strong> ${data.tiempo.toFixed(2)} min</p><p><strong>Distancia:</strong> ${data.distancia.toFixed(2)} km</p>`;
                    } else {
                        resultsDiv.innerHTML = "<p style='color:red;'>No se pudo encontrar una ruta.</p>";
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    resultsDiv.innerHTML = "<p style='color:red;'>Ocurrió un error al calcular la ruta.</p>";
                });
        });

        resetBtn.addEventListener('click', function () {
            if (startMarker) map.removeLayer(startMarker);
            if (endMarker) map.removeLayer(endMarker);
            if (routeLayer) map.removeLayer(routeLayer);

            startPoint = null;
            endPoint = null;
            startMarker = null;
            endMarker = null;
            routeLayer = null;

            calculateBtn.disabled = true;
            resultsDiv.innerHTML = "";
        });

    </script>
</body>

</html>